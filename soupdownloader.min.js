var fs=require("fs"),lazy=require("lazy"),async=require("async"),http=require("http");var count=0,countsearch=0,stream=fs.createReadStream("./soup_falk_2013-01-03.rss"),options={};
var parralelDLs=2;var path="./soupImages/";if(!fs.existsSync(path)){console.log("Creating Directory: "+path);fs.mkdirSync(path);}function downloader(a,f){var c=a.line.toString("utf8").match("<soup:attributes>(.*?)</soup:attributes>");
if(c!=null){var b=JSON.parse(c[1]);if("url" in b){var e=b.url.split("/");console.log(b.url.split("/"));options={host:e[2],port:80,path:"/"+e[3]+"/"+e[4]+"/"+e[5]};
var d=http.get(options,function(h){var g="";h.setEncoding("binary");h.on("data",function(i){g+=i;});h.on("end",function(){console.log("respnsoe ends",h);
fs.writeFile(path+"/"+e[5],g,"binary",function(i){if(i){throw i;}console.log("File saved.");f();});});});}else{f();}}else{f();}}var q=async.queue(function(a,b){console.log("hello "+a.id);
downloader(a,b);},parralelDLs);function processRssLine(a){count++;q.push({id:count.toString(),line:a},function(b){if(b){console.log("ERROR in Queue: ",b.message);
}});}q.empty=function(){console.log("NEW BATCH");stream.resume();};new lazy(stream).lines.forEach(function(a){stream.pause();processRssLine(a.toString());
});